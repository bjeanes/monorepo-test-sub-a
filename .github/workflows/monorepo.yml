on:
  push:

jobs:
  push-to-monorepo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Debug environment
        run: |
          echo "PATH=$PATH"
          which git || echo "git not found"
      
      - name: Install Git
        run: sudo apt-get update && sudo apt-get install -y git

      - name: Push to monorepo
        env:
          REMOTE_URL: ${{ secrets.JOSH }}
          TOKEN: ${{ secrets.TOKEN }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          MONOREPO: bjeanes/monorepo-test
          PATH: "sub-a"
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          AUTHED_REMOTE="https://${TOKEN}@${REMOTE_URL#https://}/${MONOREPO}.git:/${PATH}.git"

          git remote add monorepo "$AUTHED_REMOTE"

          # always push main branch
          git push monorepo "$DEFAULT_BRANCH" -o merge
          
          if [ "$BRANCH_NAME" != "$DEFAULT_BRANCH" ]; then
            git push monorepo HEAD -o base=main
          fi
