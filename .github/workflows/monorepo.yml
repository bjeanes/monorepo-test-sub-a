on:
  push:

jobs:
  push-to-monorepo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TOKEN }}

      - name: Push to monorepo
        env:
          JOSH: ${{ secrets.JOSH }}
          #TOKEN: ${{ secrets.TOKEN }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          MONOREPO: bjeanes/monorepo-test
          SUBPATH: "sub-a"
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          REMOTE_URL="${JOSH}/${MONOREPO}.git:/${SUBPATH}.git"

          git remote set-url origin "$REMOTE_URL"

          # always push main branch
          git push origin "${GITHUB_REF}:main" -o merge
          
          if [ "$BRANCH_NAME" != "$DEFAULT_BRANCH" ]; then
            git push origin HEAD:${BRANCH_NAME} -o base=main
          fi
