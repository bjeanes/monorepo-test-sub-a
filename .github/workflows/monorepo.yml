on:
  push:
jobs:
  push-to-monorepo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TOKEN }}
      - name: Push to monorepo
        env:
          JOSH: ${{ secrets.JOSH }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          MONOREPO: bjeanes/monorepo-test
          SUBPATH: "sub-a"
          IS_FORCED: ${{ github.event.forced }}
        run: "BRANCH_NAME=\"${GITHUB_REF#refs/heads/}\"\nREMOTE_URL=\"${JOSH}/${MONOREPO}.git:/${SUBPATH}.git\"\n\ngit remote add mirror \"$REMOTE_URL\"\n\n# If there isn't a commit to checkout at the subpath of the monorepo we are pushing to,\n# then we want to instruct it to merge this tree into the monorepo with `-o merge`, but\n# we do not want to pass this option otherwise\nOPTIONS=\"$(git ls-remote mirror | grep refs/heads/${DEFAULT_BRANCH} &>/dev/null || echo '-o merge')\"\n\n# always push main branch\ngit push $OPTIONS mirror \"origin/main:${DEFAULT_BRANCH}\"\n\nif [ \"$BRANCH_NAME\" != \"$DEFAULT_BRANCH\" ]; then\n  OPTIONS=\"\"\n  [[ $IS_FORCED != \"true\" ]] && OPTIONS=\"$OPTIONS -f -o force\"\n\n  git ls-remote mirror | grep \"${GITHUB_REF}\" &>/dev/null || OPTIONS=\"$OPTIONS -o base=${DEFAULT_BRANCH}\"\n  \n  git push mirror HEAD:${BRANCH_NAME} ${OPTIONS}\nfi\n"
